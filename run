#!/usr/bin/env bash        
# Main driver to run RASER    
# Author SHI Xin <shixin@ihep.ac.cn>  
# Created [2021-03-21 Sun 10:04] 

imagefile=/afs/ihep.ac.cn/users/s/shixin/raser/raser-4.0.sif
export PATH=/afs/ihep.ac.cn/soft/common/sysgroup/hep_job/bin:$PATH

raser(){
    apptainer exec --env-file cfg/env -B /cefs,/afs,/besfs5,/cvmfs,/scratchfs,/workfs2 $imagefile $1 
}

options_=(
    'Electric Profile'
    'Particle Injection'
    'Current Induction'
    'Electronics'
    'Time Resolution'
    'Space Resolution'
    'Transient Current Technique'
)

options_1=(
    'Field Calculation'
    'IV Simulation'
    'CV Simulation'
)

options_1_1=(
    'Build Devsim Database'
    'Build 1D mesh'
)

operate_1_1_1(){
    echo 'Build Devsim Database...'
    raser "./python/gen_devsim_db.py"
}

operate_1_1_2(){
    echo 'Build 1D mesh...'
    raser "./python/nju_pin_5mm_5mm_mesh.py"
}

options_1_2=(
    'Simulate I-V and electric field'
    'I-V versus defect'
    'I-V versus irradiation'
)

operate_1_2_1(){
    echo 'Simulate I-V and electric field...'
    ./python/run_batchjob.py devsim "devsim_solve.py device=1D_NJU_PIN IV=True v_max=800"
}

options_1_3=(
    'Simulate C-V'
    'C-V versus defect'
    'C-V versus irradiation'
)

operate_1_3_1(){
    echo "Simulate C-V..."
    ./python/run_batchjob.py devsim "devsim_solve.py device=1D_NJU_PIN CV=True v_max=400"
}

options_2=(
    'Particle Track'
    'Energy Deposition'
)

options_2_1=(
    'Geant4 Test'
)

operate_2_1_1(){
    echo 'Geant4 Test...'
    raser "./raser/telescope.py"
}

options_3=(
    'Signal Collection'
)

options_3_1=(
    'ROOT Test'
)

operate_3_1_1(){
    echo 'ROOT Test...'
    raser "./python/root_test.py xxx yyy zzz"
}

usage(){ 
    printf "NAME\n"
    printf "\t%s\n" "run - Main driver to run RASER"
    printf "\n"

    printf "SYNOPSIS\n"
    printf "\t%s\n" "./run [OPTION]"
    printf "\n"

    function_map

    echo "Please enter your option: "
    read option_dot
    option_udl=${option_dot//\./_}
    printf "\n"
}

function_map(){
    number_dot=$1
    number_udl=${number_dot//\./_}
    # transfer 1.1 to 1_1
    option_string_number="options_$number_udl"
    option_string="options"
    if [ -v $option_string_number ]
    # checkout whether the option_1 exist or not
    then
        eval $option_string=\(\"\${$option_string_number[@]}\"\)
        # use string to match the wanted array
        printf "OPTIONS\n"
        for ((i=1; i<=${#options[@]};i++))
        do
            if [[ $# -eq 0 ]]
            then
                printf "\t%-8s %-40s\n" $i "${options[i-1]}"
            else
                printf "\t%-8s %-40s\n" $1"."$i "${options[i-1]}"
            fi
        done
        printf "\n"
        return 1
    fi
    return 0
}
operate_test(){
    echo test
}

if [[ $# -eq 0 ]]
then
    usage
else
    option_dot=$1
    option_udl=${option_dot//\./_}
    # transfer 1.1 to 1_1
    input_para=$*
fi

while [ "$(type -t operate_$option_udl)" != function ]
do
    function_map $option_dot
    if [ $? -eq 1 ]
    then
        echo "Please enter your option: "
    else
        echo "Please enter an existing option: "
    fi
    read option_dot
    option_udl=${option_dot//\./_}
    printf "\n"
done
operate_$option_udl