#!/usr/bin/env bash        

# Main driver to run RASER    
# Author SHI Xin <shixin@ihep.ac.cn>  
# Created [2021-03-21 Sun 10:04] 


usage() { 
    printf "NAME\n\trun - Main driver to run RASER\n"
    printf "\nSYNOPSIS\n"
    printf "\n\t%-5s\n" "./run [OPTION]" 
    printf "\nOPTIONS\n"    

    printf "\n\t%-9s  %-40s"    "1.1"       "SiC-PIN"
    printf "\n\t%-9s  %-40s\n"  "1.2"       "SiC-3D"
    printf "\n\t%-9s  %-40s\n"  "1.3"       "DEVSIM"

    printf "\n\t%-9s  %-40s"    "2.1"       "SiC-LGAD"
    printf "\n\t%-9s  %-40s\n"  "2.2"       "Si-LGAD"

    printf "\n\t%-9s  %-40s"    "3.1"       "top-TCT"
    printf "\n\t%-9s  %-40s\n"  "3.2"       "edge-TCT"
    printf "\n"
}

usage_1_1() { 
    printf "\n\t%-5s  %-40s\n"  "1.1.1"    "NJU-SiC-PIN basic information for RASER simulation ..." 
    printf "\n\t%-5s  %-40s\n"  "1.1.2"    "batch model with total number, split with step number" 
    printf "\n\t%-5s  %-40s\n"  "1.1.3"    "get time resolution for NJU-SiC-PIN" 
    printf "\n\t%-5s  %-40s\n"  "1.1.4"    "HPK-Si-PIN basic information for RASER simulation ..." 
    printf "\n\t%-5s  %-40s\n"  "1.1.5"    "batch model with total number, split with step number" 
    printf "\n\t%-5s  %-40s\n"  "1.1.6"    "get time resolution for HPK-Si-PIN" 
    printf "\n"
}
usage_1_2() { 
	printf "\n\t%-5s  %-40s\n"  "1.2.1"    "3D-SiC basic information for RASER simulation ..." 
	printf "\n\t%-5s  %-40s\n"  "1.2.2.T"  "pre-run 3D-SiC batch model with total number, split with step number ..." 
	printf "\n\t%-5s  %-40s\n"  "1.2.2"    "run 3D-SiC batch model with total number, split with step number ..." 
	printf "\n\t%-5s  %-40s\n"  "1.2.3"    "get time resolution 3D-SiC multi points voltage [-50,-500] ..." 
	printf "\n\t%-5s  %-40s\n"  "1.2.4"    "get time resolution vs draw voltage ..." 
    printf "\n"
}

usage_1_3() { 
    printf "\n\t%-5s  %-40s\n"  "1.3.1"    "Initial DataBase of DEVSIM" 
    printf "\n\t%-5s  %-40s\n"  "1.3.2"    "Build 1D NJU-PIN structure"
    printf "\n\t%-5s  %-40s\n"  "1.3.3"    "Simulate 1D NJU-PIN I-V"
    printf "\n\t%-5s  %-40s\n"  "1.3.4"    "Simulate 1D NJU-PIN C-V"
    printf "\n\t%-5s  %-40s\n"  "1.3.5"    "Build 1D SICAR LGAD structure"
    printf "\n\t%-5s  %-40s\n"  "1.3.6"    "Simulate 1D SICAR LGAD I-V"
    printf "\n\t%-5s  %-40s\n"  "1.3.7"    "Simulate 1D SICAR LGAD C-V"
}

usage_2_1() { 
    printf "\n\t%-5s  %-40s\n"  "2.1.1"    "SiC-LGAD basic information for RASER simulation ..." 
    printf "\n\t%-5s  %-40s\n"  "2.1.2"    "batch model with total number, split with step number" 
    printf "\n\t%-5s  %-40s\n"  "2.1.3"    "get time resolution for SiC-LGAD, multi points doping [1e5,7e5]"
    printf "\n\t%-5s  %-40s\n"  "2.1.4"    "get time resolution vs doping ..." 
    printf "\n"
}

usage_2_2() { 
    printf "\n\t%-5s  %-40s\n"  "2.2.1"    "Si-LGAD basic information for RASER simulation ..." 
    printf "\n\t%-5s  %-40s\n"  "2.1.2"    "batch model with total number, split with step number" 
    printf "\n\t%-5s  %-40s\n"  "2.1.3"    "get time resolution for Si-LGAD, multi points voltage [200,250]"
    printf "\n\t%-5s  %-40s\n"  "2.1.4"    "get time resolution vs voltage ..." 
    printf "\n"
}

usage_3_1() { 
    printf "\n\t%-5s  %-40s\n"  "3.1.1"    "SiC-PIN top-TCT basic information ..."
    printf "\n\t%-5s  %-40s\n"  "3.1.2"    "SiC-LGAD top-TCT basic information ..."
    printf "\n"
}

usage_3_2() { 
    printf "\n\t%-5s  %-40s\n"  "3.2.1"    "SiC-PIN edge-TCT basic information ..."
    printf "\n\t%-5s  %-40s\n"  "3.2.2"    "SiC-LGAD edge-TCT basic information ..."
    printf "\n"
}

if [[ $# -eq 0 ]]; then
    usage
    echo "Please enter your option: "
    read option
else
    option=$1 
	input_para=$* 
fi

imagename=raser-1.2.sif

raser(){
    apptainer exec --env-file env -B /cefs,/afs,/besfs5,/cvmfs,/scratchfs /cvmfs/container.ihep.ac.cn/userimages/$imagename $1 
}

hepjob(){
    # export HepcMyImage=raser-1.2.sif
    export HepcMyImage=$imagename
    export PATH=$PATH:/afs/.ihep.ac.cn/soft/common/sysgroup/hepjob-4.0-dev/bin/
}

sub_1_1(){
case $option in 
    1.1.1) echo "SiC-PIN basic information for RASER simulation ..." 
        raser "./python/gsignal.py det_name=NJU-PIN parfile=setting.json" 
        ;;

	1.1.2) echo "batch model with total number, split with step number"
		hepjob
		./python/run_batchjob.py det_name=NJU-PIN step=100000 total=2000000 \
		instance=0 output=out/NJU-PIN/ batch=True para_name="NO" para_number=1 
        ;;

    1.1.3) echo "get time resolution for SiC-PIN"
        ./python/add_noise_raser.py out/pin3D/NJU-PIN/_d=10.0_v=-400.0_tmp=300.0_thick=100.0_radius=None 1
        ;;

    1.1.4) echo "Si-PIN basic information for RASER simulation ..."
        geant4 
        ./python/gsignal.py det_name=HPK-Si-PIN parfile=setting.json
        ;;

    1.1.5) echo "batch model with total number, split with step number"
		hepjob
		./python/run_batchjob.py det_name=HPK-Si-PIN step=10000 total=200000 \
							 instance=0 output=out/pin3D/HPK-Si-PIN/ batch=True para_name="NO" para_number=1 
        ;;

    1.1.6) echo "get time resolution for Si-PIN"
        ./python/add_noise_raser.py out/pin3D/HPK-Si-PIN/_d=-1.0_v=200.0_tmp=300.0_thick=50.0_radius=None 1
        ;;
        esac
}

sub_1_2(){
case $option in 
    1.2.1) echo "3D-SiC basic information for RASER simulation ..."
        geant4 
        ./python/gsignal.py det_name=plugin3D parfile=setting.json
        ;;

    1.2.2.T) echo "pre-run 3D-SiC batch model with total number, split with step number ..."
        hepjob
		./python/run_batchjob.py det_name=plugin3D step=200 total=400  \
							 instance=0 output=out/plugin3D/plugin3D/ batch=True para_name=scan_voltage para_number=10
		;; 
    1.2.2) echo "run 3D-SiC batch model with total number, split with step number ..."
        hepjob
		./python/run_batchjob.py det_name=plugin3D step=20000 total=40000  \
							 instance=0 output=out/plugin3D/plugin3D/ batch=True para_name=scan_voltage para_number=10 
        ;;
	1.2.3) echo "get time resolution 3D-SiC multi points voltage [-50,-500]"
        ./python/time_scan.py  out/plugin3D/plugin3D/ scan
			;;
	1.2.4) echo "get time resolution vs draw voltage"
		./python/time_scan.py  out/plugin3D/plugin3D/time_resolution_scan.csv draw_voltage 0
			;;
        esac
}

sub_1_3(){
case $option in 

    1.3.1) echo "Initial DataBase of DEVSIM ..."
        raser "./python/gen_devsim_db.py"
        ;;

    1.3.2) echo "Build 1D NJU-PIN structure ..."
        raser "./python/nju_pin_5mm_5mm_mesh.py"
        ;;

    1.3.3) echo "Simulate 1D NJU-PIN I-V ..."
        ./python/run_batchjob.py devsim ./python/solve_iv_pin.py
        ;;

    1.3.4) echo "Simulate 1D NJU-PIN C-V ..."
        ./python/run_batchjob.py devsim ./python/solve_cv_pin.py
        ;;

    1.3.5) echo "Build 1D SICAR1 LGAD structure ..."
        raser "./python/sicar1_lgad_mesh.py"
        ;;

    1.3.6) echo "Simulate 1D SICAR1 LGAD I-V ..."
        ./python/run_batchjob.py devsim ./python/solve_iv_lgad.py
        ;;

    1.3.7) echo "Simulate 1D SICAR1 LGAD C-V ..."
        ./python/run_batchjob.py devsim ./python/solve_cv_lgad.py
        ;;

        esac

}

sub_2_1(){
case $option in 
    2.1.1) echo "SiC-LGAD basic information for RASER simulation ..."
        geant4 
        ./python/gsignal.py det_name=SICAR-1 parfile=setting.json
        ;;

	2.1.2) echo "batch model with total number, split with step number"
		hepjob
		./python/run_batchjob.py det_name=SICAR-1  step=50000 total=200000 \
							 instance=0 output=out/lgad3D/SICAR-1/ batch=True para_name=scan_voltage para_number=10
        ;;

    2.1.3) echo "get time resolution for SiC-LGAD, multi points voltage [200,250]"
        hepjob
        ./python/time_scan.py  out/lgad3D/SICAR-1 scan
        ;;

    2.1.4) echo "get time resolution and gain efficiency vs avalanche doping"
		./python/time_scan.py  out/lgad3D/SICAR-1/time_resolution_scan.csv draw_voltage 0
        ./python/time_scan.py  out/lgad3D/SICAR-1/gain_efficiency_scan.csv gain_voltage 0
		;;
    esac
}


sub_2_2(){
case $option in 
    2.2.1) echo "Si-LGAD basic information for RASER simulation ..."
        # need to ./run raser first 
        geant4 
        ./python/gsignal.py det_name=HPK-Si-LGAD parfile=setting.json
        ;;
    2.2.2) echo "batch model with total number, split with step number"
		hepjob
		./python/run_batchjob.py det_name=HPK-Si-LGAD step=50000 total=200000 \
							 instance=0 output=out/lgad3D/HPK-Si-LGAD/ batch=True para_name=scan_voltage para_number=6
        ;;

    2.2.3) echo "get time resolution for Si-LGAD, multi points voltage [200,250]"
        hepjob
        ./python/time_scan.py  out/lgad3D/HPK-Si-LGAD scan
        ;;

    2.2.4) echo "get time resolution and gain efficiency vs avalanche doping"
		./python/time_scan.py  out/lgad3D/HPK-Si-LGAD/time_resolution_scan.csv draw_voltage 0
        ./python/time_scan.py  out/lgad3D/HPK-Si-LGAD/gain_efficiency_scan.csv gain_voltage 0
		;;
    esac
}


sub_3_1(){
case $option in 
    3.1.1) echo "SiC-PIN top-TCT basic information ..."
        geant4 
        ./python/TCTtest.py det_name=NJU-PIN parfile=setting.json laser_model=top_TCT laser_parfile=laser_setting.json
        ;;

    3.1.2) echo "SiC-LGAD top-TCT basic information ..."
        geant4 
        ./python/TCTtest.py det_name=SICAR-1 parfile=setting.json laser_model=top_TCT laser_parfile=laser_setting.json
        ;;
        esac
}

sub_3_2(){
case $option in 
    3.2.1) echo "Si-PIN edge-TCT basic information ..."
        geant4 
        ./python/TCTtest.py det_name=HPK-Si-PIN parfile=setting.json laser_model=edge_TCT_Si laser_parfile=laser_setting.json
        ;;

    3.2.2) echo "Si-LGAD edge-TCT basic information ..."
        geant4 
        ./python/TCTtest.py det_name=HPK-Si-LGAD parfile=setting.json laser_model=edge_TCT_Si laser_parfile=laser_setting.json
        ;;
        esac
}

case $option in 
    raser) echo "Loading RASER..."
        echo "Please setup the raser cmd by [source ./run raser]..."
        ;; 

    1.1) echo "RASER simulate NJU-SiC-PIN"
        usage_1_1
        echo "Please enter your option: " 
        read option 
        sub_1_1 option 
        ;;
    1.1.*) echo "RASER simulate NJU-SiC-PIN"
        sub_1_1 option
        ;;

    1.2) echo "RASER simulate 3D-SiC"
        usage_1_2
        echo "Please enter your option: " 
        read option 
        sub_1_2 option 
        ;;
    1.2.*) echo "RASER simulate 3D-SiC"
        sub_1_2 option
        ;;

    1.3) echo "DEVSIM"
        usage_1_3
        echo "Please enter your option: " 
        read option 
        sub_1_3 option 
        ;;
    1.3.*) echo "DEVSIM"
        sub_1_3 option
        ;;

    2.1) echo "RASER simulate SiC-LGAD"
        usage_2_1
        echo "Please enter your option: " 
        read option 
        sub_2_1 option 
        ;;
    2.1.*) echo "RASER simulate SiC-LGAD"
        sub_2_1 option
        ;;

    2.2) echo "RASER simulate Si-LGAD"
        usage_2_2
        echo "Please enter your option: " 
        read option 
        sub_2_2 option 
        ;;
    2.2.*) echo "RASER simulate Si-LGAD"
        sub_2_2 option
        ;;

    3.1) echo "RASER simulate top-TCT"
        usage_3_1
        echo "Please enter your option: " 
        read option 
        sub_3_1 option 
        ;;
    3.1.*) echo "RASER simulate top-TCT"
        sub_3_1 option
        ;;

    3.2) echo "RASER simulate edge-TCT"
        usage_3_2
        echo "Please enter your option: " 
        read option 
        sub_3_2 option 
        ;;
    3.2.*) echo "RASER simulate edge-TCT"
        sub_3_2 option
        ;;

		esac
