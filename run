#!/usr/bin/env bash        
# Main driver to run RASER    
# Author SHI Xin <shixin@ihep.ac.cn>  
# Created [2021-03-21 Sun 10:04] 

imagefile=/afs/ihep.ac.cn/users/s/shixin/raser/raser-4.0.sif
export PATH=/afs/ihep.ac.cn/soft/common/sysgroup/hep_job/bin:$PATH

raser(){
    apptainer exec --env-file cfg/env -B /cefs,/afs,/besfs5,/cvmfs,/scratchfs,/workfs2 $imagefile $1 
}

options_=(
    'Electric Profile'
    'Particle Injection'
    'Current Induction'
    'Electronics'
    'Time Resolution'
    'Space Resolution'
    'Transient Current Technique'
)

options_1=(
    'Field Calculation'
    'IV Simulation'
    'CV Simulation'
)

options_1_1=(
    'Build Devsim Database'
    'Show Field'
    'Gain Calculation'
)

1.1.1(){
    echo 'Build Devsim Database...'
    raser "python/devsim_test.py xxx yyy zzz"
}

1.1.2(){
    echo 'Show Field...'
    raser "python/field_calculation.py xxx yyy zzz"
}

1.1.3(){
    echo 'Gain Calculation...'
    raser "python/gain_calculation.py xxx yyy zzz"
}

options_2=(
    'Particle Track'
    'Energy Deposition'
)

options_2_1=(
    'Geant4 Test'
)

2.1.1(){
    echo 'Geant4 Test...'
    raser "python/geant4_test.py xxx yyy zzz"
}

options_3=(
    'Signal Collection'
)

options_3_1=(
    'ROOT Test'
)

3.1.1(){
    echo 'ROOT Test...'
    raser "python/root_test.py xxx yyy zzz"
}

usage(){ 
    printf "NAME\n"
    printf "\t%s\n" "run - Main driver to run RASER"
    printf "\n"

    printf "SYNOPSIS\n"
    printf "\t%s\n" "./run [OPTION]"
    printf "\n"

    function_map

    echo "Please enter your option: "
    read option
    printf "\n"
}

function_map(){
    q=$1
    r=${q//\./_}
    # transfer 1.1 to 1_1
    s="options_$r"
    t="options"
    if [ -v $s ]
    # checkout whether the option_1 exist or not
    then
        eval $t=\(\"\${$s[@]}\"\)
        # use string to match the wanted array
        printf "OPTIONS\n"
        for ((i=1; i<=${#options[@]};i++))
        do
            if [[ $# -eq 0 ]]
            then
                printf "\t%-8s %-40s\n" $i "${options[i-1]}"
            else
                printf "\t%-8s %-40s\n" $1"."$i "${options[i-1]}"
            fi
        done
        printf "\n"
        return 1
    fi
    return 0
}

if [[ $# -eq 0 ]]
then
    usage
else
    option=$1
    input_para=$*
fi

while [ "$(type -t $option)" != function ]
do
    function_map $option
    if [ $? -eq 1 ]
    then
        echo "Please enter your option: "
    else
        echo "Please enter an existing option: "
    fi
    read option
    printf "\n"
done
$option